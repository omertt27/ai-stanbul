<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Formatting Final Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: white;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: #2a2a2a;
        }
        .api-content {
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .api-content h1, .api-content h2, .api-content h3 {
            color: #fff;
            margin: 20px 0 10px 0;
        }
        .api-content p {
            margin: 15px 0;
            color: #ddd;
        }
        .api-content ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        .api-content li {
            margin: 8px 0;
            color: #ccc;
        }
        .api-content strong {
            font-weight: bold;
            color: #fff;
        }
        .api-content em {
            font-style: italic;
            color: #ccc;
        }
        .api-content code {
            background-color: #555;
            color: #ff6;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        button {
            background-color: #007acc;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background-color: #005a9e;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background-color: #0a4d0a;
            color: #4ade80;
        }
        .status.error {
            background-color: #4d0a0a;
            color: #f87171;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Blog Formatting Final Test</h1>
        <p>This test verifies that markdown formatting is working correctly with real backend data.</p>
        
        <div class="test-section">
            <h2>API Test</h2>
            <button onclick="testPost('1')">Test Post 1</button>
            <button onclick="testPost('2')">Test Post 2</button>
            <button onclick="testPost('3')">Test Post 3</button>
            <button onclick="testPost('4')">Test Post 4</button>
            <div id="status"></div>
        </div>
        
        <div class="test-section">
            <h2>Formatted Content</h2>
            <div id="formatted-content" class="api-content">
                <p>Click a test button above to load and format blog content.</p>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8001';
        
        // Same formatInlineText function from BlogPost.jsx
        const formatInlineText = (text) => {
            if (!text) return text;
            
            let result = text;
            
            // 1. Bold italic (***text***)
            result = result.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            
            // 2. Bold (**text**)
            result = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // 3. Italic (*text*)
            result = result.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
            
            // 4. Underscore italic (_text_)
            result = result.replace(/\b_([^_]+?)_\b/g, '<em>$1</em>');
            
            // 5. Code (`text`)
            result = result.replace(/`([^`]+?)`/g, '<code class="bg-gray-700 text-yellow-300 px-1 py-0.5 rounded text-sm">$1</code>');
            
            // 6. Links [text](url)
            result = result.replace(/\[([^\]]+?)\]\(([^)]+?)\)/g, '<a href="$2" class="text-blue-400 hover:text-blue-300 underline" target="_blank" rel="noopener noreferrer">$1</a>');
            
            return result;
        };
        
        const formatContent = (content) => {
            const lines = content.split('\n');
            const elements = [];
            let currentList = [];
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                
                // Skip empty lines
                if (!trimmedLine) {
                    // If we were building a list, close it
                    if (currentList.length > 0) {
                        elements.push(`<ul>${currentList.join('')}</ul>`);
                        currentList = [];
                    }
                    return;
                }
                
                // Handle different heading levels
                if (trimmedLine.startsWith('# ')) {
                    if (currentList.length > 0) {
                        elements.push(`<ul>${currentList.join('')}</ul>`);
                        currentList = [];
                    }
                    const text = trimmedLine.slice(2);
                    elements.push(`<h1>${formatInlineText(text)}</h1>`);
                } else if (trimmedLine.startsWith('## ')) {
                    if (currentList.length > 0) {
                        elements.push(`<ul>${currentList.join('')}</ul>`);
                        currentList = [];
                    }
                    const text = trimmedLine.slice(3);
                    elements.push(`<h2>${formatInlineText(text)}</h2>`);
                } else if (trimmedLine.startsWith('### ')) {
                    if (currentList.length > 0) {
                        elements.push(`<ul>${currentList.join('')}</ul>`);
                        currentList = [];
                    }
                    const text = trimmedLine.slice(4);
                    elements.push(`<h3>${formatInlineText(text)}</h3>`);
                } else if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**') && !trimmedLine.includes('***')) {
                    if (currentList.length > 0) {
                        elements.push(`<ul>${currentList.join('')}</ul>`);
                        currentList = [];
                    }
                    const text = trimmedLine.slice(2, -2);
                    elements.push(`<h3>${formatInlineText(text)}</h3>`);
                } else if (trimmedLine.startsWith('- ')) {
                    const listText = trimmedLine.slice(2);
                    currentList.push(`<li>${formatInlineText(listText)}</li>`);
                } else {
                    // If we were building a list, close it
                    if (currentList.length > 0) {
                        elements.push(`<ul>${currentList.join('')}</ul>`);
                        currentList = [];
                    }
                    // Regular paragraph
                    elements.push(`<p>${formatInlineText(trimmedLine)}</p>`);
                }
            });
            
            // Close any remaining list
            if (currentList.length > 0) {
                elements.push(`<ul>${currentList.join('')}</ul>`);
            }
            
            return elements.join('');
        };
        
        async function testPost(postId) {
            const statusDiv = document.getElementById('status');
            const contentDiv = document.getElementById('formatted-content');
            
            statusDiv.className = 'status';
            statusDiv.textContent = `Loading blog post ${postId}...`;
            contentDiv.innerHTML = '<p>Loading...</p>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/blog/${postId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const post = data.post || data;
                
                statusDiv.className = 'status success';
                statusDiv.textContent = `✅ Successfully loaded "${post.title}"`;
                
                // Format the content
                const formattedContent = formatContent(post.content);
                contentDiv.innerHTML = `
                    <h1>${post.title}</h1>
                    <p><strong>Author:</strong> ${post.author_name || post.author}</p>
                    <p><strong>Category:</strong> ${post.category} | <strong>District:</strong> ${post.district}</p>
                    <p><strong>Views:</strong> ${post.views} | <strong>Likes:</strong> ${post.likes || post.likes_count}</p>
                    <hr style="margin: 20px 0; border-color: #555;">
                    ${formattedContent}
                `;
                
                // Log for debugging
                console.log('Original content (first 200 chars):', post.content.substring(0, 200));
                console.log('Formatted content (first 200 chars):', formattedContent.substring(0, 200));
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
                contentDiv.innerHTML = `<p>Error loading content: ${error.message}</p>`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
