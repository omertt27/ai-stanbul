<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Istanbul - Debug Connection Issues</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .status-card {
            background: #f8f9fa;
            border-left: 5px solid #6c757d;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .status-card.success { border-color: #28a745; background: #d4edda; }
        .status-card.error { border-color: #dc3545; background: #f8d7da; }
        .status-card.warning { border-color: #ffc107; background: #fff3cd; }
        .status-card.info { border-color: #17a2b8; background: #d1ecf1; }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .test-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .json-result {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è AI Istanbul - Restaurant API Debug Tool</h1>
            <p>Use this tool to diagnose connection issues with the restaurant descriptions API</p>
        </div>

        <div id="status-container">
            <div class="status-card info" id="main-status">
                <strong>üîç Initializing diagnostics...</strong>
            </div>
        </div>

        <div class="test-grid">
            <button class="test-button" onclick="testBasicConnection()">
                üåê Test Basic Connection
            </button>
            <button class="test-button" onclick="testRestaurantSearch()">
                üîç Test Restaurant Search
            </button>
            <button class="test-button" onclick="testPopularRestaurants()">
                ‚≠ê Test Popular Restaurants
            </button>
            <button class="test-button" onclick="testDistrictSearch()">
                üèõÔ∏è Test District Search
            </button>
            <button class="test-button" onclick="testWithDifferentPorts()">
                üîÑ Try Different Ports
            </button>
            <button class="test-button" onclick="runFullDiagnostic()">
                üîß Full Diagnostic
            </button>
        </div>

        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        const possibleUrls = [
            'http://localhost:8001',
            'http://127.0.0.1:8001',
            'http://localhost:8000',
            'http://127.0.0.1:8000'
        ];
        
        let workingUrl = null;

        function updateStatus(message, type = 'info', showLoading = false) {
            const status = document.getElementById('main-status');
            status.innerHTML = `${showLoading ? '<div class="loading"></div> ' : ''}${message}`;
            status.className = `status-card ${type}`;
        }

        function showResults(content) {
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.innerHTML = content;
        }

        function addStatusCard(message, type = 'info') {
            const container = document.getElementById('status-container');
            const card = document.createElement('div');
            card.className = `status-card ${type}`;
            card.innerHTML = message;
            container.appendChild(card);
        }

        async function findWorkingUrl() {
            if (workingUrl) return workingUrl;
            
            for (const url of possibleUrls) {
                try {
                    const response = await fetch(`${url}/docs`, { 
                        method: 'GET',
                        mode: 'cors'
                    });
                    if (response.ok) {
                        workingUrl = url;
                        return url;
                    }
                } catch (error) {
                    console.log(`${url} failed:`, error.message);
                }
            }
            return null;
        }

        async function testBasicConnection() {
            updateStatus('üîç Testing basic connection...', 'info', true);
            
            const url = await findWorkingUrl();
            if (url) {
                updateStatus(`‚úÖ Backend found at: <strong>${url}</strong>`, 'success');
                addStatusCard(`‚úÖ Successfully connected to: ${url}`, 'success');
                return true;
            } else {
                updateStatus('‚ùå Cannot connect to backend server', 'error');
                addStatusCard(`‚ùå Tried all URLs: ${possibleUrls.join(', ')}`, 'error');
                addStatusCard(`üí° <strong>Solution:</strong> Make sure to start the backend server:<br>
                    <code>cd backend && uvicorn main:app --reload --port 8001</code>`, 'warning');
                return false;
            }
        }

        async function testRestaurantSearch() {
            updateStatus('üîç Testing restaurant search...', 'info', true);
            
            const baseUrl = await findWorkingUrl();
            if (!baseUrl) {
                updateStatus('‚ùå No backend connection available', 'error');
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/restaurants/search?limit=2`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateStatus(`‚úÖ Restaurant search working! Found ${data.total_found} restaurants`, 'success');
                    showResults(`
                        <h3>üçΩÔ∏è Restaurant Search Results</h3>
                        <div class="json-result">${JSON.stringify(data, null, 2)}</div>
                    `);
                } else {
                    updateStatus(`‚ùå API returned error: ${data.status}`, 'error');
                    showResults(`<div class="json-result">${JSON.stringify(data, null, 2)}</div>`);
                }
            } catch (error) {
                updateStatus(`‚ùå Request failed: ${error.message}`, 'error');
                addStatusCard(`‚ùå Fetch Error: ${error.message}`, 'error');
            }
        }

        async function testPopularRestaurants() {
            updateStatus('‚≠ê Testing popular restaurants...', 'info', true);
            
            const baseUrl = await findWorkingUrl();
            if (!baseUrl) {
                updateStatus('‚ùå No backend connection available', 'error');
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/restaurants/popular?min_rating=4.0&limit=3`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateStatus(`‚úÖ Popular restaurants working! Found ${data.total_found} restaurants`, 'success');
                    const restaurantsList = data.restaurants.map(r => 
                        `<li><strong>${r.name}</strong> (${r.rating}‚òÖ) - ${r.address.substring(0, 50)}...</li>`
                    ).join('');
                    
                    showResults(`
                        <h3>‚≠ê Popular Restaurants</h3>
                        <ul>${restaurantsList}</ul>
                        <details>
                            <summary>View Full JSON Response</summary>
                            <div class="json-result">${JSON.stringify(data, null, 2)}</div>
                        </details>
                    `);
                } else {
                    updateStatus(`‚ùå API returned error: ${data.status}`, 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå Request failed: ${error.message}`, 'error');
            }
        }

        async function testDistrictSearch() {
            updateStatus('üèõÔ∏è Testing district search...', 'info', true);
            
            const baseUrl = await findWorkingUrl();
            if (!baseUrl) {
                updateStatus('‚ùå No backend connection available', 'error');
                return;
            }

            try {
                // Properly encode Turkish characters
                const district = encodeURIComponent('Beyoƒülu');
                const response = await fetch(`${baseUrl}/restaurants/search?district=${district}&limit=2`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateStatus(`‚úÖ District search working! Found ${data.total_found} restaurants in Beyoƒülu`, 'success');
                    addStatusCard('‚úÖ Turkish character encoding working correctly', 'success');
                    showResults(`
                        <h3>üèõÔ∏è Beyoƒülu Restaurants</h3>
                        <p><strong>Location searched:</strong> ${data.location_searched}</p>
                        <div class="json-result">${JSON.stringify(data, null, 2)}</div>
                    `);
                } else {
                    updateStatus(`‚ùå District search failed: ${data.status}`, 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå District search failed: ${error.message}`, 'error');
                addStatusCard(`‚ùå This might be a URL encoding issue with Turkish characters`, 'warning');
            }
        }

        async function testWithDifferentPorts() {
            updateStatus('üîÑ Testing different ports...', 'info', true);
            
            for (const url of possibleUrls) {
                try {
                    const response = await fetch(`${url}/restaurants/search?limit=1`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addStatusCard(`‚úÖ <strong>${url}</strong> - Working! Found ${data.total_found || 0} restaurants`, 'success');
                        workingUrl = url;
                    } else {
                        addStatusCard(`‚ùå <strong>${url}</strong> - HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    addStatusCard(`‚ùå <strong>${url}</strong> - ${error.message}`, 'error');
                }
            }
            
            if (workingUrl) {
                updateStatus(`‚úÖ Found working backend at: ${workingUrl}`, 'success');
            } else {
                updateStatus('‚ùå No working backend found on any port', 'error');
            }
        }

        async function runFullDiagnostic() {
            // Clear previous results
            document.getElementById('status-container').innerHTML = `
                <div class="status-card info" id="main-status">
                    <strong>üîß Running full diagnostic...</strong>
                </div>
            `;
            
            updateStatus('üîß Running comprehensive diagnostic...', 'info', true);
            
            // Test 1: Basic connection
            addStatusCard('üîç <strong>Test 1:</strong> Basic connection test', 'info');
            const hasConnection = await testBasicConnection();
            
            if (!hasConnection) {
                addStatusCard('üõë <strong>DIAGNOSIS:</strong> Backend server is not running or not accessible', 'error');
                addStatusCard(`üí° <strong>SOLUTION:</strong> 
                    <br>1. Open terminal in your project directory
                    <br>2. Run: <code>cd backend</code>
                    <br>3. Run: <code>uvicorn main:app --reload --port 8001</code>
                    <br>4. Wait for "Application startup complete" message
                    <br>5. Refresh this page and test again`, 'warning');
                return;
            }
            
            // Test 2: CORS check
            addStatusCard('üîç <strong>Test 2:</strong> CORS configuration', 'info');
            try {
                const response = await fetch(`${workingUrl}/restaurants/search?limit=1`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Origin': window.location.origin
                    }
                });
                if (response.ok) {
                    addStatusCard('‚úÖ CORS is properly configured', 'success');
                } else {
                    addStatusCard(`‚ùå CORS issue: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                addStatusCard(`‚ùå CORS Error: ${error.message}`, 'error');
            }
            
            // Test 3: API endpoints
            addStatusCard('üîç <strong>Test 3:</strong> Testing all API endpoints', 'info');
            const endpoints = [
                '/restaurants/search?limit=1',
                '/restaurants/popular?limit=1',
                '/docs'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${workingUrl}${endpoint}`);
                    if (response.ok) {
                        addStatusCard(`‚úÖ ${endpoint} - Working`, 'success');
                    } else {
                        addStatusCard(`‚ùå ${endpoint} - HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    addStatusCard(`‚ùå ${endpoint} - ${error.message}`, 'error');
                }
            }
            
            updateStatus('üéâ Diagnostic complete! Check results above.', 'success');
        }

        // Auto-run basic connection test on page load
        window.addEventListener('load', () => {
            setTimeout(testBasicConnection, 500);
        });
    </script>
</body>
</html>
